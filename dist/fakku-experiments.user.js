// ==UserScript==
// @name         FAKKU Experiments
// @author       Daiz
// @namespace    fakku-experiments
// @version      1.2.0
// @description  Experimental frontend features for FAKKU.
// @match        https://www.fakku.net/*
// @updateURL    https://github.com/Daiz/fakku-experiments/raw/stable/dist/fakku-experiments.user.js
// @downloadURL  https://github.com/Daiz/fakku-experiments/raw/stable/dist/fakku-experiments.user.js
// @grant        none
// @run-at       document-end
// ==/UserScript==
/*!
  FAKKU Experiments - Experimental frontend features for FAKKU.
  Copyright (C) 2018 Daiz

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
var PRODUCTION = true;
!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);var o=document;function n(e,t){return void 0===t&&(t=o),t.querySelector(e)}function a(e,t){return void 0===t&&(t=o),Array.prototype.slice.call(t.querySelectorAll(e))}var i,s,l={log:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("[FE]"),console.log.apply(console,e)},error:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("[FE]"),console.error.apply(console,e)},trace:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("[FE]"),console.error.apply(console,e)}},u=function(e,t,r,o){return new(r||(r=Promise))(function(n,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(i,s)}l((o=o.apply(e,t||[])).next())})},c=function(e,t){var r,o,n,a,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,o&&(n=o[2&a[0]?"return":a[0]?"throw":"next"])&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[0,n.value]),a[0]){case 0:case 1:n=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(n=(n=i.trys).length>0&&n[n.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){i.label=a[1];break}if(6===a[0]&&i.label<n[1]){i.label=n[1],n=a;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(a);break}n[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],o=0}finally{r=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},f=document,d=window,h=/\/(magazines|publishers|artists|tags|events|circles|series|developers)\/([^\/]*)$/,g=/comic-bavel|comic-europa|comic-kairakuten|comic-x-eros|girls-form/,p=/hentai|uncensored|book|subscription|doujin|anime|ecchi|non-h|dubbed|subbed|censored|illustration|spread|interview|western/;function v(e,t){return e[0].toLowerCase()>t[0].toLowerCase()?1:-1}function b(e){var t=e[1],r=e[2].match(g);return[t,r?r[0]:e[2]]}function m(e){var t=f.createDocumentFragment(),r=f.createElement("li");return r.id="header-"+e.toLowerCase(),r.style.border="0",r.style.padding="0",r.innerHTML="<h2>"+e+"</h2>",t.appendChild(r),t}function w(e,t){return e[0]-t[0]}(s=i||(i={})).Green="#0A9D54",s.Turquoise="#16a085",s.Blue="#2980b9",s.Purple="#8e44ad",s.Black="#2c3e50",s.Yellow="#f39c12",s.Orange="#d35400",s.Red="#9D0A0A",s.White="#bdc3c7",s.Gray="#7f8c8d",s.Null="";var y="fakku-experiments-followed",P="https://www.fakku.net/account/following",q=6048e5;(new(function(){return function(){var e=this;this.store=[],this.queuedStoreUpdate=!1,this.queuedStoreSave=!1,this.queuedPageEnhance=!1,this.queuedFollowingPageUpdate=!1,this.queuedAttributePageUpdate=!1,this.initialStoreLoad=!0,this.initialPageEnhance=!0,this.init=function(){e.storeLoad(),d.addEventListener("storage",e.storeLoad);var t=location.href.match(h);if(t){var r=b(t),o=r[0],n=r[1];e.attributePageInit(o,n)}else location.href===P&&e.followingPageInit()},this.attributePageInit=function(t,r){var o=n(".attribute-follow > a");if(o){var a=new MutationObserver(e.attributePageObserver);l.log("Monitoring attribute page follow button"),a.observe(o,{attributes:!0}),o.classList.contains("js-unsubscribe")?e.setAttr(t,r,!0)&&e.queuePageEnhance():o.classList.contains("js-subscribe")&&e.setAttr(t,r,!1)&&e.queuePageEnhance()}},this.attributePageUpdate=function(){e.queuedAttributePageUpdate=!1;var t=n(".attribute-follow > a"),r=location.href.match(h);if(t&&r){var o=b(r),a=o[0],i=o[1],s=e.getAttr(a,i),l=n("i",t);s&&!0===s.following?(t.classList.remove("js-subscribe"),t.classList.remove("light"),t.classList.add("js-unsubscribe"),t.classList.add("pushed"),l.classList.remove("bt-bell"),l.classList.add("bt-check")):(t.classList.remove("js-unsubscribe"),t.classList.remove("pushed"),t.classList.add("js-subscribe"),t.classList.add("light"),l.classList.remove("bt-check"),l.classList.add("bt-bell")),e.queuePageEnhance()}},this.attributePageObserver=function(t){t.forEach(function(t){var r=t.target,o=location.href.match(h);if(o){var n=b(o),a=n[0],i=n[1];r.classList.contains("js-unsubscribe")?e.setAttr(a,i,!0)&&e.queuePageEnhance():r.classList.contains("js-subscribe")&&e.setAttr(a,i,!1)&&e.queuePageEnhance()}})},this.followingPageInit=function(){var t={publishers:m("Publishers"),developers:m("Developers"),magazines:m("Magazines"),series:m("Series"),tags:m("Tags"),artists:m("Artists"),circles:m("Circles"),events:m("Events")},r=[],o=n(".following-list");if(o){for(var a in e.followingPageParser(f,t),t){var i=t[a],s=i.children.length;s>1&&r.push([s,i])}r.sort(w).forEach(function(e){o.appendChild(e[1])}),new MutationObserver(e.followingPageObserver).observe(o,{childList:!0})}},this.followingPageParser=function(t,r){var o=n(".following-list",t);if(o){var s=[];return a("li",o).forEach(function(t){var a=n("a",t),l=a?a.href.match(h):null;if(l){var u=b(l),c=u[0],f=u[1];s.push(c+"/"+f);var d=e.getAttr(c,f),g=d?d.color:i.Null;e.setAttr(c,f,!0,g),r&&r[c].appendChild(t)}else r&&o.removeChild(t)}),e.store.forEach(function(t){-1===s.indexOf(t.type+"/"+t.name)&&e.setAttr(t.type,t.name,!1)}),l.log("Store updated"),!0}return l.error("Unable to parse following list"),!1},this.followingPageUpdate=function(){e.queuedFollowingPageUpdate=!1;var t={removed:[],added:[],removedTypes:{}},r=e.store,o=n(".following-list"),i=a("li",o).filter(function(e){return n("a",e)}).map(function(r){var o=b(n("a",r).href.match(h)),a=o[0],i=o[1],s=e.getAttr(a,i);return s&&!1!==s.following||t.removed.push([a,i]),a+"/"+i});if(r.forEach(function(e){var r=-1===i.indexOf(e.type+"/"+e.name);!0===e.following&&r&&t.added.push([e.type,e.name])}),t.added.length>0)location.reload();else if(t.removed.length>0)for(var s in t.removed.forEach(function(e){var r=e[0],a=n('a[href="/'+r+"/"+e[1]+'"]',o);if(t.removedTypes[r]=!0,a){var i=a.parentNode;o.removeChild(i)}}),t.removedTypes)if(0===e.getAttrTypeFollowedCount(s)){var l=n("#header-"+s,o);l&&o.removeChild(l)}},this.followingPageObserver=function(t){t.forEach(function(t){Array.prototype.slice.call(t.removedNodes).forEach(function(t){var r=n("a",t),o=r?r.href.match(h):"";if(o){var a=b(o),i=a[0],s=a[1];if(e.setAttr(i,s,!1),0===e.getAttrTypeFollowedCount(i)){l.log("removing header for",i);var u=n("#header-"+i);if(u){var c=u.parentElement;c&&c.removeChild(u)}}}})})},this.storeSave=function(){e.queuedStoreSave=!1,localStorage.setItem(y,JSON.stringify({store:e.store,updated:Date.now()})),l.log("Saved store to localStorage")},this.storeLoad=function(){var t=localStorage.getItem(y),r=!0;if(t){l.log("Loaded store from localStorage");var o=JSON.parse(t),n=o.store,a=o.updated,i=new Date(a),s=Date.now();e.store=n,i.getTime()>=s-q&&(r=!1)}r&&e.queueStoreUpdate(),e.initialStoreLoad?e.queuePageEnhance():location.href===P?e.queueFollowingPageUpdate():h.test(location.href)&&e.queueAttributePageUpdate(),e.initialStoreLoad=!1},this.setAttr=function(t,r,o,n){void 0===n&&(n=i.Null);var a=!0,s=e.getAttr(t,r);if(s){var u=s.following!==o,c=s.color===i.Null||n!==i.Null&&s.color!==n;u||c?(s.color===i.Null&&n===s.color&&(n=i.Green),l.log('Attribute "'+t+"/"+r+'": '+(u?"Changed 'following': "+s.following+" -> "+o+" | ":"")+" "+(c?"Changed 'color': "+s.color+" -> "+n:"")),u&&(s.following=o),c&&(s.color=n)):a=!1}else n=n===i.Null?i.Green:n,l.log('Attribute "'+t+"/"+r+"\": Added with 'following': "+o+" and 'color': "+n),e.store.push({type:t,name:r,following:o,color:n});return a&&e.queueStoreSave(),a},this.getAttr=function(t,r){for(var o=e.store,n=0;n<o.length;++n){var a=o[n];if(a.type===t&&a.name===r)return a}},this.getAttrTypeFollowedCount=function(t){for(var r=e.store,o=0,n=0;n<r.length;++n){var a=r[n];a.type===t&&!0===a.following&&++o}return o},this.storeUpdate=function(){return u(e,void 0,void 0,function(){var e,t,r,o;return c(this,function(n){switch(n.label){case 0:this.queuedStoreUpdate=!1,l.log("Updating store via Following page fetch"),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,fetch(P,{credentials:"include"})];case 2:return e=n.sent(),t=f.createElement("html"),r=t,[4,e.text()];case 3:return r.innerHTML=n.sent(),this.followingPageParser(t)&&this.queuePageEnhance(),[3,5];case 4:return o=n.sent(),l.error(o),[3,5];case 5:return[2]}})})},this.queueStoreSave=function(){e.queuedStoreSave||(e.queuedStoreSave=!0,requestAnimationFrame(e.storeSave))},this.queueStoreUpdate=function(){l.log("Queuing Store Update"),e.queuedStoreUpdate||(e.queuedStoreUpdate=!0,requestAnimationFrame(e.storeUpdate))},this.queuePageEnhance=function(){l.log("Queuing Page Enhance"),e.queuedPageEnhance||(e.queuedPageEnhance=!0,requestAnimationFrame(e.pageEnhance))},this.queueFollowingPageUpdate=function(){l.log("Queuing Following Page Update"),e.queuedFollowingPageUpdate||(e.queuedFollowingPageUpdate=!0,requestAnimationFrame(e.followingPageUpdate))},this.queueAttributePageUpdate=function(){l.log("Queuing Attribute Page Update"),e.queuedAttributePageUpdate||(e.queuedAttributePageUpdate=!0,requestAnimationFrame(e.attributePageUpdate))},this.pageEnhance=function(){e.queuedPageEnhance=!1,l.log("Enhancing page");var t=a(".content-meta"),r=n(".content-right");r&&t.push(r),t.forEach(function(t){a(".row").forEach(function(t){var r=n(".row-left",t).textContent||"";if(r&&!r.match(/pages|description/i)){var o=a(".row-right > a",t);if(o.forEach(function(t){var r=t,o=r.href.match(h);if(o){var n=b(o),a=n[0],i=n[1],s="tags"===a,l=e.getAttr(a,i);if(s&&e.initialPageEnhance){var u=r.classList.contains("subscribed");u!==(!!l&&l.following)&&(console.log("discrepancy update",a,i,u),e.setAttr(a,i,u))}l&&!0===l.following?(r.classList.add("subscribed"),s?(r.style.backgroundColor=l.color,r.style.borderColor=l.color):(r.style.color=l.color,r.style.fontWeight="bold")):(r.classList.remove("subscribed"),r.removeAttribute("style")),s&&p.test(i)&&(r.style.opacity="0.75",r.style.borderStyle="dashed")}}),e.initialPageEnhance=!1,"Tags"===r){var i=n(".tags",t),s=[],l=[],u=[];o.forEach(function(t){var r=t,o=r.href.match(h);if(o){var n=o[2],a=p.test(n),i=e.getAttr("tags",n);a?u.push([n,r]):i&&i.following?s.push([n,r]):l.push([n,r])}}),function(e){for(;e.firstChild;)e.removeChild(e.firstChild)}(i),s.sort(v),l.sort(v),u.sort(v),s.concat(l).concat(u).forEach(function(e){i.appendChild(e[1]),i.appendChild(f.createTextNode(" "))})}}})})}}}())).init(),function(){var e=document,t=e.querySelector("#content-collections"),r=e.querySelector("#chapters"),o=e.querySelector("#comments"),n=t||r;if(n&&o){var a=o.parentElement;a&&a.insertBefore(n,o)}}()}]);